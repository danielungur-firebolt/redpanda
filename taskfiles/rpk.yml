version: '3'

tasks:
  build:
    desc: build rpk
    vars:
      RPK_VERSION: '{{default "latest" .TAG_NAME}}'
    env:
      GOOS: '{{OS | lower}}'
      GOPATH: '{{.BUILD_ROOT}}/go'
      CGO_ENABLED: "0"
    dir: "{{.SRC_DIR}}/src/go/rpk"
    cmds:
    - mkdir -p "{{.BUILD_ROOT}}/go/$GOOS/bin"
    - |
      ver_pkg='github.com/danielungur-firebolt/redpanda/src/go/rpk/pkg/cli/cmd/version'
      cont_pkg='github.com/danielungur-firebolt/redpanda/src/go/rpk/pkg/cli/cmd/container/common'
      go build \
        -modcacherw \
        -ldflags \
          "-X ${ver_pkg}.version={{.RPK_VERSION}} \
           -X ${ver_pkg}.rev={{.SHORT_SHA}} \
           -X ${cont_pkg}.tag={{.RPK_VERSION}}" \
        -o "{{.BUILD_ROOT}}/go/$GOOS/bin" ./...
  tidy:
    desc: mod tidy rpk
    env:
      CGO_ENABLED: "0"
    dir: "{{.SRC_DIR}}/src/go"
    cmds:
    - |
      for dir in $(find . -maxdepth 1 -type d ! -path .); do
        cd $dir; go mod tidy; cd ..
      done
